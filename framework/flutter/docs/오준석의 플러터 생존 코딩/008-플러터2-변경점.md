| 내용 | 최초 작성일 | 참고 |
|---|:---:|---:|
| 플러터2 변경점 | 2021-08-10 | 소문난 명강의 : 오준석의 플러터 생존 코딩 |
# 1. 널 안전성
널 안전성(null safety)은 다트 2.12.0 및 플러터2부터 공식 지원된다.
## 1.1 널 안전이란?
다음 코드를 봅시다.  
len()메서드는 문자열을 매개변수로 받도록 되어 있습니다.
```dart
String name = '홍길동';
print(len(name)); //3
...
int len(String str) => str.length;
```
개발자는 실수로 len()함수에 널을 전달할 수도 있다.  
이 코드를 작성 중에는 무엇이 잘못된 것인지 인지하기 어렵다. 하지만 막상 실행해보면 에러가 발생한다.  
```dart
String name = null;
print(len(name)); //3
...
int len(String str) => str.length;
```
널을 허용할지 말지를 컴파일 단계에서 결정할 수 있다면 애초에 실수할 가능성이 줄어든다.  
https://dartpad.dev 에는 널 안전성(Null Safety)기능을 켜고 끌 수 있는 옵션이 있어 널 안전성을 사전에 경험해 볼 수 있다.
## 2.1 널에 안전한 코드
https://dartpad.dev 에서 널 안전성 기능을 활성화하고 다음 코드를 작성하면 에러가 발생한다.  
하지만 우리가 작성하고 있던 플러터 프로젝트에서는 해당 코드에서 에러가 발생하지 않는다.
```dart
int i = null; //error
```
널 안전성을 도입하면 해당 변수 타입이 널을 허용하는지 아닌지를 정확하게 대입해야 한다.  
널을 대입하기 위해서는 타입 옆에 ?를 붙이기만 하면 된다.
```dart
int? i = null; //OK
```
따라서 ?가 붙어있지 않은 타입은 널을 대입할 수 없게 된다.
## 1.3 타입 시스템의 변화
기존의 다트는 모든 타입이 널을 허용했다.  
하지만 널 안전성을 도입하게 되면서 `널을 허용하지 않는 타입`과 `널을 허용하는 타입`으로 구분할 수 있다.  
유형 이론 용어에서 Null유형은 모든 유형의 하위 유형으로 처리된다.
![`널을 허용하지 않는 타입`과 `널을 허용하는 타입`으로 구분](https://dart.dev/null-safety/understanding-null-safety/bifurcate.png)  
기존에는 모든 타입에 널이 대입될 수 있었고, 널 타입은 최하위 타입이었다.  
그리고 모든 타입은 Object타입 기반이었다.  
![널 안전성 적용 전의 타입 시스템](https://dart.dev/null-safety/understanding-null-safety/hierarchy-before.png)
널 안전성이 적용되면 기존 타입에 널이 대입될 수 없으므로, 널 타입은 이제 어떠한 타입과도 관계없는 별도 타입으로 취급된다.
![널 안전성 적용 후의 타입 시스템](https://dart.dev/null-safety/understanding-null-safety/hierarchy-after.png)
널을 허용하는 타입의 경우 해당 타입과 널을 모두 대입할 수 있으므로 다음과 같은 상속관계로 표현할 수 있다.
![널을 허용하는 타입과 널의 관계](https://dart.dev/null-safety/understanding-null-safety/nullable-hierarchy.png)
  
그렇다면 원래 다트의 최상위 갯체로 취급되는 Object는 어떨까?  
String의 경우와 마찬가지로 Object?가 최상위 객체 타입이 된다.  
또한 널을 허용하지 않는 타입에서는 기존에 널이 자리했던 최하위 객체에 어떤 값도 담을 수 없는 Never라는 특수한 타입이 추가된다.
![널을 허용하는 타입에서의 상속관계](https://dart.dev/null-safety/understanding-null-safety/top-and-bottom.png)
결론적으로 널 안전성이 도입되면 String과 String?는 다른 타입으로 취급된다.  
널을 잘못 참조하는 일은 개발하면서 가장 흔히 발생할 수 있는 실수 중 하나이다.  
이런 실수를 줄이기 위해 특별한 이유가 없다면 널을 허용하지 않는 방향으로 코딩하는 것을 권장한다.  
널 안전성은 실행 전 오류를 알려주기 때문에 실수로 널 조작하는 것을 방지한다.  
널 참조를 잘못하여 발생하는 에러가 굉장히 많은데 널 안전성을 통해 많은 에러를 예방할 수 있다.  
공식문서 참고 : https://dart.dev/null-safety/understanding-null-safety
## 1.4 널에 안전한 코드 작성
널 안전성 적용 시 주로 만나게 되는 몇 가지 에러를 예시를 통해 본다.
### 늦은 초기화
다음 코드는 기존에는 전혀 문제없던 클래스를 생성하는 방식 중 하나이다.  
이 코드는 널 안전성을 적용했을 때 문법적으로 에러가 발생한다.
```dart
class Person {
    int age; //선언 시 null, error

    Person() {
        age = 20; //생성자에서 초기화
    }
}
```
int 타입은 널을 허용하지 않기 때문에 age를 선언하면 에러가 발생한다.  
이 코드를 안전하게 널에 작성하려면 late키워드를 선언 앞에 붙이면 된다.  
late키워드는 늦게 초기화가 된다는 것을 명시하는 키워드다.
```dart
class Person {
    late int age;

    Person() {
        age = 20; //생성자에서 초기화 OK
    }
}
```
널로 사용되지 않는 변수지만 조금 늦게 값을 할당하고 싶은 경우에 사용한다.  
`지연된 초기화로 값이 할당된 이후 다시 널로 할당할 수 없다.`
### 널일 수 있는 값을 처리하는 방법
??를 사용하면 널을 허용하지 않는 타입으로 변환할 수 있다.
```dart
int value = nullableValue ?? 0 //nullableValue가 null이면 0을 아니면 그 값
```
그리고 널을 허용하는 타입을 매개변수로 사용하는 메서드가 있다면 명확히 타입을 정의해줘야한다.  
널 체크는 확실히 해야하니 주의해야한다.
```dart
int len(String? str) {
    if (str == null) {
        return 0;
    }
    return str.length;
}
```
또한 널일 수 있는 변수에 널이 아닌 값이 들어있는 경우 이것을 널이 아닌 타입으로 사용하고 싶을 때, !를 붙이면 강제로 널이 아님을 명시하게 된다.
```dart
int? nullableValue = 10;
int value = nullableValue!; //!를 붙이면 null이 아님을 명시하여 형 변환이 됨.
```
만약 위 코드에서 nullableValue가 널이면 예외 발생으로 프로그램이 종료된다.  
이런 코드는 컴파일 타임에 에러가 발생하지 않기 때문에 !는 사용하지 않는 것을 권장한다.  
!보다는 ??를 활용하는 것을 생각하는게 좋다.  
널을 처리하는 또 다른 형태로 널이 아닐 때만 참조하도록 하는 ?. 활용 방법이 있다.  
메서드를 호출할 때, .보다 ?.를 사용하면 별도의 널 체크 없이 안전하게 메서드를 호출할 수 있다.
```dart
int? nullableValue = 10;
print(nullableValue?.toString()); //10출력
```
물론 다음과 같이 널이 출력되는 이상한 상황이 생길 수 있는데, 앱이 종료되는 불상사는 막을 수 있으니 적절한 널 처리만 추가로 해주면 된다.
```dart
int? nullableValue = null;
print(nullableValue?.toString()); //null출력
```
컬렉션을 다룰 때에도 명확히 타입을 명시해 줄 필요가 있다.
```dart
List<String>
List<String>?
List<String?>
List<String?>?
```
## 1.5 널 안전성 적용 시 장점
널 안전성을 적용했을 때의 장점은 위에서 본 것 외에도 다음과 같은 부분이 있다.
- 널을 허용하지 않는 변수는 널이 아님을 100% 보장한다.
- (따라서) 개발자의 실수를 미연에 방지할 수 있다.
- 항상 예측이 가능한 코딩을 할 수 있다.
- 컴파일러가 변수의 널 검사를 진행하지 않아도 되기 때문에 컴파일 속도가 대폭 향상된다.
## 1.6 널 안전성 적용 시 주의점
널 안전성은 좋아 보이지만 적용 시 다음과 같은 주의가 필요한다.
- 사용 중인 외부 라이브러리도 모두 널 안전성을 지원해야 한다.
- ?, !, ?., late 등의 새로운 연산자나 키워드는 초보자에게 어렵게 느껴질 수 있다.
- 사용 중인 프로젝트에 갑자기 컴파일 에러가 발생할 수 있고, 이를 수정하기 위한 추가 작업이 필요하다.
## 1.7 널 안전성 수동으로 적용하기
프로젝트를 생성하면 기본적으로 널이 허용된다.  
pubspec.yaml 파일을 열어보면 다음과 같은 부분을 찾을 수 있다.  
이 부분은 다트 버전을 명시하는 부분으로 2.7.0 버전부터 사용할 수 있는 것을 확인할 수 있다.
```
environment:
    sdk: ">=2.7.0 <3.0.0"
```
다음과 같이 널 안전성을 지원하는 2.12.0 버전을 최소 버전으로 수정하고 `Pub get`을 실행하면 이제부터 프로젝트가 널 안전성을 지원하게 된다.
```
environment:
    sdk: ">=2.12.0 <3.0.0"
```
이렇게 하면 널 안전성이 지원되면서 모호한 타입의 모든 부분에 에러가 발생하게 된다.
## 1.8 널 안전성 마이그레이션
다행히도 구글에서 널 안전성을 변경하고자 할 때 도움을 주는 마이그레이션 도구를 제공한다.  
마이그레이션 도구는 코드 수정이 필요한 부분을 찾아, 그 이유와 함께 수정을 제안하기 때문에 보다 안전하게 널 안전성을 지원하도록 도와준다.  
먼저 마이그레이션 도구를 사용하기 전에 컴파일이 되도록 다트 버전을 원래대로 2.7.0으로 돌려놓고 `Pub get`을 수행한다.  
다음으로 안드로이드 스튜디오의 하단 터미널에 커맨드 명령어로 dart migrate를 입력한다.  
프로젝트 분석 후 링크가 표시되는데 널 안전성 적용 시 코드가 어떻게 변경되는지를 분석해서 보여주는 웹페이지가 열린다.  
잠시 후 자동으로 기존 프로젝트를 널 안전성이 도입된 코드로 변환해 준다.  
그러면 자동으로 기존 프로젝트를 널 안전성이 도입된 코드로 변환해준다.  
링크 하나 표시 되는데 이 링크를 클릭하면 어떤 파일에 몇 가지 변경 사항이 있는지 그 내용이 무엇인지 보여준다.  
## 2. 지원 기기 확대
플러터 2로 업데이트 되면서 기존의 안드로이드, iOS뿐만 아니라 웹이 공식적으로 지원된다.  
또한 데스크톱을 베타로 지원하게 되면서 진정한 의미의 멀티 플랫폼 개발 프레임워크가 되었다.
데스크톱으로 실행 : https://flutter.dev/desktop

